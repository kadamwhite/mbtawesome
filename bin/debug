#!/usr/bin/env node
var debug = require( 'debug' )( 'init' );
var app = require( '../server' );
var _ = require( 'lodash' );

// Get any command-line arguments
var argv = require( 'minimist' )( process.argv.slice( 2 ) );

// Use data fixtures: Configure Replay behavior based on config
// or command-line parameters (e.g. debug --fixture=normal-service)
var config = require( '../server/services/config' );
var fixtureDir;
if ( _.isString( argv.f ) ) {
  fixtureDir = argv.f;
} else if ( _.isString( argv.fixture ) ) {
  fixtureDir = argv.fixture;
} else {
  fixtureDir = config.api.fixtures;
}

// Set up replay to mock API with the selected fixtures
var Replay = require( 'replay' );
// Use the fixture set specified in the config
var path = require( 'path' );
Replay.fixtures = path.join( __dirname, '../fixtures/' + fixtureDir );

// Optionally set record mode from the CLI
if ( process.argv.record || process.argv.r ) {
  Replay.mode = 'record';
}

app.set( 'port', process.env.PORT || 3000 );

var server = app.listen( app.get( 'port' ), function() {
  debug( 'Express server listening on port ' + server.address().port );
});
